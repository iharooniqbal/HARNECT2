<!doctype html>
<html lang="en">
<head>

  <!-- ================= META & SEO ================= -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b5cff">
  <meta name="description" content="HARNECT is a social media-style web app to connect and share moments.">
  <meta name="keywords" content="HARNECT, social media, Flask, Pakistan, photos, videos">
  <meta name="author" content="Abdullah Haroon">

  <!-- ================= TITLE ================= -->
  <title>HARNECT - Feedback</title>

  <!-- ================= STYLES & PWA ================= -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-192.png') }}">
  <style>
    .feedback-item { border:1px solid #ccc; padding:10px; margin:10px 0; border-radius:5px; position: relative; }
    .feedback-actions { position: absolute; top:10px; right:10px; }
    .feedback-actions button { margin-left:5px; }
    textarea { width:100%; padding:5px; }
    button { margin-top:5px; }
  </style>

</head>
<body>

<div class="fade">

  <!-- ================= TOP NAVBAR ================= -->
  <header class="top-nav">
    <div class="logo">
      <span class="logo-blue">HAR</span><span class="logo-brown">NECT</span>
    </div>
    <div class="page-title">Feedback</div>
    <div class="theme-toggle" id="themeToggle">üåô</div>
  </header>

  <!-- ================= MAIN CONTENT ================= -->
  <main class="content feedback-page">

    <!-- ================= PAGE HEADING ================= -->
    <h2>Feedback</h2>

    <!-- ================= FEEDBACK FORM ================= -->
    <form id="feedbackForm">
      <input type="text" name="name" placeholder="Your Name (optional)">
      <textarea name="message" placeholder="Write your feedback..." required></textarea>
      <button type="submit">Submit Feedback</button>
    </form>

    <!-- ================= FEEDBACK LIST ================= -->
    <div id="feedbackList" class="feedback-list">
      {% if feedbacks %}
        {% for fb in feedbacks %}
          <div class="feedback-item" data-id="{{ fb.id }}">
            <strong>{{ fb.name }}</strong>
            <p class="msg">{{ fb.message }}</p>
            {% if fb.name == user %}
            <div class="feedback-actions">
              <button class="edit-btn">Edit</button>
              <button class="delete-btn">Delete</button>
            </div>
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <p>No feedback yet. Be the first to give feedback!</p>
      {% endif %}
    </div>

  </main>

  <!-- ================= BOTTOM NAVIGATION ================= -->
  <nav class="bottom-nav">
    <a href="{{ url_for('index') }}">üè†<span>Home</span></a>
    <a href="{{ url_for('explore') }}">üîç<span>Explore</span></a>
    <a href="{{ url_for('upload') }}" class="upload-btn">‚ûï</a>
    <a href="{{ url_for('feedback') }}" class="active">üí¨<span>Feedback</span></a>
    <a href="{% if user %}{{ url_for('profile', username=user) }}{% else %}{{ url_for('login') }}{% endif %}">
      üë§<span>Profile</span>
    </a>
  </nav>

  <!-- ================= FEEDBACK SCRIPT ================= -->
  <script>
    const feedbackForm = document.getElementById('feedbackForm');
    const feedbackList = document.getElementById('feedbackList');

    function renderFeedback(feedbacks){
      feedbackList.innerHTML = '';
      if(feedbacks.length === 0){
        feedbackList.innerHTML = '<p>No feedback yet. Be the first to give feedback!</p>';
        return;
      }
      feedbacks.forEach(f => {
        const div = document.createElement('div');
        div.className = 'feedback-item';
        div.setAttribute('data-id', f.id);
        div.innerHTML = `<strong>${f.name}</strong>
                         <p class="msg">${f.message}</p>`;
        if(f.name === "{{ user }}"){
          const actions = document.createElement('div');
          actions.className = 'feedback-actions';
          actions.innerHTML = `<button class="edit-btn">Edit</button>
                               <button class="delete-btn">Delete</button>`;
          div.appendChild(actions);
        }
        feedbackList.appendChild(div);
      });
    }

    // Add feedback
    feedbackForm.addEventListener('submit', function(e){
      e.preventDefault();
      const formData = new FormData(feedbackForm);
      const data = {
        action: 'add',
        name: formData.get('name') || "{{ user }}",
        message: formData.get('message') || ''
      };
      if (!data.message.trim()) return;

      fetch("{{ url_for('feedback') }}", {
        method: 'POST',
        body: new URLSearchParams(data)
      })
      .then(res => res.json())
      .then(feedbacks => {
        renderFeedback(feedbacks);
        feedbackForm.reset();
      })
      .catch(err => console.error(err));
    });

    // Edit feedback
    feedbackList.addEventListener('click', function(e){
      if(e.target.classList.contains('edit-btn')){
        const item = e.target.closest('.feedback-item');
        const id = item.getAttribute('data-id');
        const msgEl = item.querySelector('.msg');
        const newMsg = prompt('Edit feedback:', msgEl.textContent);
        if(newMsg === null || !newMsg.trim()) return;
        fetch("{{ url_for('feedback') }}", {
          method: 'POST',
          body: new URLSearchParams({action:'edit', id:id, message:newMsg.trim()})
        })
        .then(res => res.json())
        .then(feedbacks => renderFeedback(feedbacks))
        .catch(err => console.error(err));
      }

      // Delete feedback
      if(e.target.classList.contains('delete-btn')){
        if(!confirm('Are you sure you want to delete this feedback?')) return;
        const item = e.target.closest('.feedback-item');
        const id = item.getAttribute('data-id');
        fetch("{{ url_for('feedback') }}", {
          method: 'POST',
          body: new URLSearchParams({action:'delete', id:id})
        })
        .then(res => res.json())
        .then(feedbacks => renderFeedback(feedbacks))
        .catch(err => console.error(err));
      }
    });
  </script>

  <!-- ================= GLOBAL SCRIPT ================= -->
  <script src="{{ url_for('static', filename='script.js') }}"></script>

</div>

</body>
</html>
