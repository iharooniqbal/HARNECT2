<!doctype html>
<html lang="en">
<head>

  <!-- ================= META & SEO ================= -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b5cff">
  <meta name="description" content="HARNECT is a social media-style web app to connect and share moments.">
  <meta name="keywords" content="HARNECT, social media, Flask, Pakistan, photos, videos">
  <meta name="author" content="Abdullah Haroon">

  <!-- ================= TITLE ================= -->
  <title>HARNECT â€” Feed</title>

  <!-- ================= STYLES & PWA ================= -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-192.png') }}">

</head>
<body>

<!-- ================= PAGE FADE WRAPPER ================= -->
<div class="fade">

  <!-- ================= TOP NAVBAR ================= -->
  <header class="top-nav">
    <div class="logo">HARNECT</div>
    <div class="page-title">Home</div>
    <div class="theme-toggle" id="themeToggle">ğŸŒ™</div>
  </header>

  <!-- ================= STORIES SECTION ================= -->
  <div class="stories">

    <!-- ================= USER STORY ================= -->
    {% if user %}
{% set my_story = stories | selectattr('username','equalto',user) | list %}
{% if my_story %}
<div class="story your-story" onclick="openStories('{{ user }}')">
  <div class="story-circle">
    {% set file = my_story[-1].filename %}
    {% if file.endswith(('.mp4','.webm','.ogg','.avi')) %}
      <video muted><source src="{{ url_for('uploaded_file', filename=file) }}"></video>
    {% else %}
      <img src="{{ url_for('uploaded_file', filename=file) }}">
    {% endif %}
    <button class="story-menu-btn" onclick="event.stopPropagation();toggleStoryMenu(this)">â‹®</button>
    <div class="story-menu">
      <button onclick="deleteStory({{ my_story[-1].id }})">Delete</button>
    </div>
  </div>
  <p>You</p>
</div>
{% endif %}
{% endif %}

{% set shown_users=[] %}
{% for story in stories %}
{% if story.username!=user and story.username not in shown_users %}
{% set _=shown_users.append(story.username) %}
<div class="story" onclick="openStories('{{ story.username }}')">
  <div class="story-circle">
    {% if story.filename.endswith(('.mp4','.webm','.ogg','.avi')) %}
      <video muted><source src="{{ url_for('uploaded_file', filename=story.filename) }}"></video>
    {% else %}
      <img src="{{ url_for('uploaded_file', filename=story.filename) }}">
    {% endif %}
  </div>
</div>
{% endif %}
{% endfor %}

</div>
    <!-- ================= OTHER USERS STORIES ================= -->
    {% set shown_users = [] %}
    {% for story in stories %}
      {% if story.username != user and story.username not in shown_users %}
        {% set _ = shown_users.append(story.username) %}
        <div class="story" onclick="openStories('{{ story.username }}')">
          <div class="story-circle">
            {% set file = story.filename %}
            {% if file.endswith(('.mp4', '.webm', '.ogg', '.avi')) %}
              <video class="story-video" muted>
                <source src="{{ url_for('uploaded_file', filename=file) }}" type="video/mp4">
              </video>
            {% else %}
              <img src="{{ url_for('uploaded_file', filename=file) }}" alt="@{{ story.username }} Story">
            {% endif %}
          </div>
        </div>
      {% endif %}
    {% endfor %}

  </div>

  <!-- ================= FEED CONTENT ================= -->
  <main class="content feed">

    <!-- ================= POSTS LOOP ================= -->
    {% for post in posts %}
      <div class="post" id="post-{{ post.id }}">

        <!-- ================= POST MEDIA ================= -->
        {% if post.filename.endswith(('.mp4','.webm','.ogg','.avi')) %}
          <video controls>
            <source src="{{ url_for('uploaded_file', filename=post.filename) }}" type="video/mp4">
            Your browser does not support the video.
          </video>
        {% else %}
          <img src="{{ url_for('uploaded_file', filename=post.filename) }}" alt="{{ post.caption }}">
        {% endif %}

        <!-- ================= POST INFO ================= -->
        <div class="post-info">
          <p><strong>@{{ post.username }}</strong></p>
          <p>{{ post.caption }}</p>
        </div>

        <!-- ================= POST ACTIONS ================= -->
        <div class="post-actions">
          <button class="like-btn {% if post['liked'] %}liked{% endif %}" 
        data-post-id="{{ post['id'] }}" 
        data-like-count="{{ post['like_count'] }}"
        onclick="likePost(event, {{ post['id'] }}, this)">
  â¤ï¸ {{ post['like_count'] }} Likes
</button>


          <form class="comment-form" onsubmit="submitComment(event, {{ post.id }})">
            <input type="text" name="comment" placeholder="Add comment..." required>
            <button type="submit">ğŸ’¬ Comment</button>
          </form>

          <button class="share-btn" onclick="sharePost('{{ url_for('uploaded_file', filename=post.filename) }}')">
            ğŸ”„ Share
          </button>

          {% if user == post.username %}
            <button onclick="deletePost({{ post.id }}, 'post-{{ post.id }}')">ğŸ—‘ï¸ Delete</button>
          {% endif %}

        </div>

        <!-- ================= COMMENTS ================= -->
        <div class="comments" id="comments-{{ post.id }}">
          {% for c in post.comments %}
          <div class="comment" id="comment-{{ c.id }}">
            <strong>@{{ c.username }}:</strong>
            <span class="comment-text">{{ c.text }}</span>
            {% if user == c.username %}
            <button onclick="editComment({{ c.id }})">âœï¸</button>
            <button onclick="deleteComment({{ c.id }})">ğŸ—‘ï¸</button>
            {% endif %}
          </div>
          {% endfor %}

        </div>

      </div>
    {% endfor %}

  </main>

  <!-- ================= BOTTOM NAVIGATION ================= -->
  <nav class="bottom-nav">
    <a href="{{ url_for('index') }}" class="active">ğŸ <span>Home</span></a>
    <a href="{{ url_for('explore') }}">ğŸ”<span>Explore</span></a>
    <a href="{{ url_for('upload') }}" class="upload-btn">â•</a>
    <a href="{{ url_for('feedback') }}">ğŸ’¬<span>Feedback</span></a>
    <a href="{% if user %}{{ url_for('profile', username=user) }}{% else %}{{ url_for('login') }}{% endif %}">ğŸ‘¤<span>Profile</span></a>
  </nav>

</div>

<!-- ================= STORIES DATA ================= -->
<script id="storiesData" type="application/json">
[
{% for s in stories %}
  {
    "id": {{ s.id }},
    "username": "{{ s.username }}",
    "url": "{{ url_for('uploaded_file', filename=s.filename) }}",
    "type": "{{ s.type }}"
  }{% if not loop.last %},{% endif %}
{% endfor %}
]
</script>

<!-- ================= SCRIPTS ================= -->
<script src="{{ url_for('static', filename='script.js') }}"></script>

<!-- ================= STORY MODAL ================= -->
<div id="storyModal" class="story-modal" style="display:none;">
  <span class="close" onclick="closeStoryModal()">&times;</span>

  <div class="story-progress">
    <div id="storyProgressBar"></div>
  </div>

  <div id="storyContent" class="story-click-zone"></div>
</div>

</body>
</html>
