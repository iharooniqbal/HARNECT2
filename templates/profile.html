<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HARNECT - {{ profile.username }}'s Profile</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
<link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-192.png') }}">
<meta name="theme-color" content="#0b5cff">
</head>
<body>
<div class="fade">

<!-- ================= HEADER ================= -->
<header class="top-nav">
  <div class="logo">HARNECT</div>
  <div class="page-title">{{ profile.username }}'s Profile</div>
  <div class="theme-toggle" id="themeToggle">üåô</div>
</header>

<!-- ================= PROFILE CONTENT ================= -->
<main class="content profile-page">
  <div class="profile-info">
    <!-- PROFILE DP WITH CLICKABLE MODAL -->
   <img src="{{ url_for('static', filename='uploads/' + profile.profile_pic) }}" class="profile-dp" id="profileDP">
    <div id="dpModal" class="dp-modal">
      <span class="close-btn">&times;</span>
      <img id="modalImg" class="dp-modal-content">
    </div>
    
    <h2>{{ profile.username }}</h2>
    <p>{{ profile.bio }}</p>

    <div class="profile-stats">
      <div><strong>{{ posts|length }}</strong><span>Posts</span></div>
      <div><strong>{{ followers_count }}</strong><span>Followers</span></div>
      <div><strong>{{ following_count }}</strong><span>Following</span></div>
    </div>

    {% if user != profile.username %}
      {% if is_following %}
        <a href="{{ url_for('follow_user', username=profile.username) }}" class="btn unfollow">Following</a>
      {% else %}
        <a href="{{ url_for('follow_user', username=profile.username) }}" class="btn follow">Follow</a>
      {% endif %}
    {% endif %}

    {% if user == profile.username %}
      <form id="editProfileForm" action="{{ url_for('profile', username=profile.username) }}" method="POST" enctype="multipart/form-data">
        <input type="text" name="username" placeholder="Username" value="{{ profile.username }}">
        <input type="text" name="bio" placeholder="Bio" value="{{ profile.bio }}">
        <input type="file" name="profile_pic" accept="image/*">
        <button type="submit">Update Profile</button>
      </form>
      <form action="{{ url_for('logout') }}">
        <button type="submit">Logout</button>
      </form>
    {% endif %}
  </div>

  <!-- ================= PROFILE POSTS ================= -->
  <h3>{{ profile.username }}'s Posts</h3>
  <div class="profile-grid">
    {% for post in posts %}
      <div class="post" id="post-{{ post.id }}">
        {% if post.filename.endswith(('.mp4','.webm','.mov','.avi')) %}
          <video controls width="100%">
            <source src="{{ url_for('static', filename='uploads/' + post.filename) }}" type="video/mp4">
          </video>
        {% else %}
          <img src="{{ url_for('static', filename='uploads/' + post.filename) }}" alt="{{ post.caption }}">
        {% endif %}

        <div class="post-actions">
          <button onclick="likePost(event, {{ post.id }}, this)" class="like-btn {% if user in post.likes %}liked{% endif %}">‚ù§Ô∏è {{ post.likes|length if post.likes else 0 }} Likes</button>
          <button onclick="toggleComment({{ post.id }})">üí¨ Comment</button>
          <button onclick="sharePost('{{ url_for('static', filename='uploads/' + post.filename) }}')">üîÑ Share</button>
          {% if user == profile.username %}
            <button onclick="deletePost({{ post.id }}, 'post-{{ post.id }}')">üóëÔ∏è Delete</button>
          {% endif %}
        </div>

        <div class="comments" id="comments-{{ post.id }}">
          {% for c in post.comments %}
            <div class="comment" id="comment-{{ c.id }}">
              <strong>@{{ c.username }}:</strong>
              <span class="comment-text">{{ c.text }}</span>
              {% if user == c.username %}
                <button class="comment-edit-btn" data-id="{{ c.id }}">‚úèÔ∏è</button>
                <button class="comment-delete-btn" data-id="{{ c.id }}">üóëÔ∏è</button>
              {% endif %}
            </div>
          {% endfor %}
          {% if user %}
            <form class="comment-form" onsubmit="submitComment(event, {{ post.id }})">
              <input type="text" name="comment" placeholder="Add comment..." required>
              <button type="submit">üí¨ Comment</button>
            </form>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>
</main>

<!-- ================= BOTTOM NAV ================= -->
<nav class="bottom-nav">
  <a href="{{ url_for('index') }}">üè†<span>Home</span></a>
  <a href="{{ url_for('explore') }}">üîç<span>Explore</span></a>
  <a href="{{ url_for('upload') }}" class="upload-btn">‚ûï</a>
  <a href="{{ url_for('feedback') }}">üí¨<span>Feedback</span></a>
  <a href="{% if user %}{{ url_for('profile', username=user) }}{% else %}{{ url_for('login') }}{% endif %}">üë§<span>Profile</span></a>
</nav>

<!-- ================= SCRIPTS ================= -->
<script src="{{ url_for('static', filename='script.js') }}"></script>
<script>
// Delete Post
function deletePost(postId, postElementId){
  if(!confirm("Are you sure you want to delete this post?")) return;
  fetch(`/delete_post/${postId}`, { method:'POST' })
  .then(res=>res.json())
  .then(data=>{if(data.success)document.getElementById(postElementId).remove();else alert(data.error||"Could not delete post.");});
}

// DP Modal
const dp=document.getElementById("profileDP"),modal=document.getElementById("dpModal"),modalImg=document.getElementById("modalImg"),closeBtn=modal.querySelector(".close-btn");
dp.onclick=()=>{modal.style.display="flex";modalImg.src=dp.src;}
closeBtn.onclick=()=>modal.style.display="none";
modal.onclick=e=>{if(e.target===modal)modal.style.display="none";}
</script>

<style>
.profile-dp{width:130px;height:130px;border-radius:50%;object-fit:cover;border:3px solid var(--accent);box-shadow:0 4px 12px rgba(0,0,0,.2);cursor:pointer;transition:transform .3s}.profile-dp:hover{transform:scale(1.05)}
.dp-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:9999;justify-content:center;align-items:center;padding:20px;display:flex}
.dp-modal-content{max-width:90%;max-height:80%;border-radius:12px;object-fit:contain;box-shadow:0 6px 20px rgba(0,0,0,.5);animation:scalePop .35s ease}
.dp-modal .close-btn{position:absolute;top:20px;right:25px;font-size:32px;color:#fff;cursor:pointer;background:none;border:none;transition:transform .2s}.dp-modal .close-btn:hover{transform:scale(1.2)}
</style>

</div>
</body>
</html>
