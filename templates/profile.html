<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HARNECT - {{ profile.username }}'s Profile</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <meta name="theme-color" content="#0b5cff">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-192.png') }}">
</head>
<body>
<div class="fade">
<header class="top-nav">
  <div class="logo">HARNECT</div>
  <div class="page-title">{{ profile.username }}'s Profile</div>
  <div class="theme-toggle" id="themeToggle">ğŸŒ™</div>
</header>

<main class="content profile-page">
  <div class="profile-info">
    <img src="{{ url_for('static', filename='uploads/' + profile.profile_pic) }}" alt="Profile Pic" class="profile-pic">
    <h2>{{ profile.username }}</h2>
    <p>{{ profile.bio }}</p>

    {% if user != profile.username %}
      <button id="followBtn" onclick="toggleFollow('{{ profile.username }}', this)">
        {% if user in profile.followers %}
          Unfollow
        {% else %}
          Follow
        {% endif %}
      </button>
      <p id="followersCount">{{ profile.followers|length }} followers</p>
    {% endif %}

    {% if user == profile.username %}
      <form id="editProfileForm" action="{{ url_for('profile', username=profile.username) }}" method="POST" enctype="multipart/form-data">
        <input type="text" name="username" placeholder="Username" value="{{ profile.username }}">
        <input type="text" name="bio" placeholder="Bio" value="{{ profile.bio }}">
        <input type="file" name="profile_pic" accept="image/*">
        <button type="submit">Update Profile</button>
      </form>
      <form action="{{ url_for('logout') }}">
        <button type="submit">Logout</button>
      </form>
    {% endif %}
  </div>

  <h3>{{ profile.username }}'s Posts</h3>
  <div class="profile-grid">
    {% for post in posts %}
      <div class="post" id="post-{{ post.id }}">
        {% if post.filename.endswith(('.mp4','.webm','.mov','.avi')) %}
          <video controls width="100%">
            <source src="{{ url_for('static', filename='uploads/' + post.filename) }}" type="video/mp4">
          </video>
        {% else %}
          <img src="{{ url_for('static', filename='uploads/' + post.filename) }}" alt="{{ post.caption }}">
        {% endif %}
        <div class="post-actions">
          <button onclick="likePost(event, {{ post.id }}, this)" class="like-btn {% if user in post.likes %}liked{% endif %}">
            â¤ï¸ {{ post.likes|length if post.likes else 0 }} Likes
          </button>
          <button onclick="toggleComment({{ post.id }})">ğŸ’¬ Comment</button>
          <button onclick="sharePost('{{ url_for('static', filename='uploads/' + post.filename) }}')">ğŸ”„ Share</button>
          {% if user == profile.username %}
            <button onclick="deletePost({{ post.id }}, 'post-{{ post.id }}')">ğŸ—‘ï¸ Delete</button>
          {% endif %}
        </div>
        <div class="comments" id="comments-{{ post.id }}">
          {% for c in post.comments %}
            <p><strong>@{{ c.username }}:</strong> {{ c.text }}</p>
          {% endfor %}
          {% if user %}
            <form class="comment-form" onsubmit="submitComment(event, {{ post.id }})">
              <input type="text" name="comment" placeholder="Add comment..." required>
              <button type="submit">ğŸ’¬ Comment</button>
            </form>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>
</main>

<nav class="bottom-nav">
  <a href="{{ url_for('index') }}">ğŸ <span>Home</span></a>
  <a href="{{ url_for('explore') }}">ğŸ”<span>Explore</span></a>
  <a href="{{ url_for('upload') }}" class="upload-btn">â•</a>
  <a href="{{ url_for('feedback') }}">ğŸ’¬<span>Feedback</span></a>
  <a href="{% if user %}{{ url_for('profile', username=user) }}{% else %}{{ url_for('login') }}{% endif %}">ğŸ‘¤<span>Profile</span></a>
</nav>

<script src="{{ url_for('static', filename='script.js') }}"></script>
<script>
// Delete Post
function deletePost(postId, postElementId) {
  if (!confirm("Are you sure you want to delete this post?")) return;
  fetch(`/delete_post/${postId}`, { method: 'POST' })
    .then(res => res.json())
    .then(data => {
      if (data.success) document.getElementById(postElementId).remove();
      else alert(data.error || "Could not delete post.");
    });
}

// Follow/Unfollow
function toggleFollow(username, btn) {
  fetch(`/follow/${username}`, { method: 'POST', headers: {'Content-Type':'application/json'} })
    .then(res => res.json())
    .then(data => {
      if (data.error) return alert(data.error);
      btn.textContent = data.action === 'followed' ? 'Unfollow' : 'Follow';
      const countEl = document.getElementById('followersCount');
      if (countEl) countEl.textContent = `${data.followers_count} followers`;
    });
}
</script>
</div>
</body>
</html>
